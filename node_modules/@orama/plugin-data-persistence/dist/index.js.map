{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { decode, encode } from '@msgpack/msgpack'\nimport type { AnyOrama } from '@orama/orama'\nimport { create, load, save } from '@orama/orama'\nimport type { PersistenceFormat, Runtime } from './types.js'\n// @ts-expect-error dpack does not expose types\nimport * as dpack from 'dpack'\nimport { METHOD_MOVED, UNSUPPORTED_FORMAT } from './errors.js'\nimport { detectRuntime } from './utils.js'\nimport { serializeOramaInstance, deserializeOramaInstance } from './seqproto.js'\n\nconst hexFromMap: Record<string, number> = {\n  0: 0,\n  1: 1,\n  2: 2,\n  3: 3,\n  4: 4,\n  5: 5,\n  6: 6,\n  7: 7,\n  8: 8,\n  9: 9,\n  a: 10,\n  b: 11,\n  c: 12,\n  d: 13,\n  e: 14,\n  f: 15\n}\nconst hexToMap = Object.keys(hexFromMap)\n\n/* c8 ignore next 13 */\nfunction slowHexToBuffer(hex: string): Uint8Array {\n  const bytes = new Uint8Array(Math.floor(hex.length / 2))\n\n  hex = hex.toLowerCase()\n  for (let i = 0; i < hex.length; i++) {\n    const a = hexFromMap[hex[i * 2]]\n    const b = hexFromMap[hex[i * 2 + 1]]\n    if (a === undefined || b === undefined) {\n      break\n    }\n    bytes[i] = (a << 4) | b\n  }\n  return bytes\n}\n\n/* c8 ignore next 5 */\nfunction slowHexToString(bytes: Uint8Array): string {\n  return Array.from(bytes || [])\n    .map((b) => hexToMap[b >> 4] + hexToMap[b & 15])\n    .join('')\n}\n\nexport async function persist<T extends AnyOrama>(\n  db: T,\n  format: PersistenceFormat = 'binary',\n  runtime?: Runtime\n): Promise<string | Buffer | ArrayBuffer> {\n  if (!runtime) {\n    runtime = detectRuntime()\n  }\n\n  const dbExport = await save(db)\n  let serialized: string | Buffer | ArrayBuffer\n\n  switch (format) {\n    case 'json':\n      serialized = JSON.stringify(dbExport)\n      break\n    case 'dpack':\n      serialized = dpack.serialize(dbExport)\n      break\n    case 'binary': {\n      const msgpack = encode(dbExport)\n      if (runtime === 'node') {\n        serialized = Buffer.from(msgpack.buffer, msgpack.byteOffset, msgpack.byteLength)\n        serialized = serialized.toString('hex')\n        /* c8 ignore next 3 */\n      } else {\n        serialized = slowHexToString(msgpack)\n      }\n      break\n    }\n    case 'seqproto':\n      serialized = serializeOramaInstance(db)\n      break\n    default:\n      throw new Error(UNSUPPORTED_FORMAT(format))\n  }\n\n  return serialized\n}\n\nexport async function restore<T extends AnyOrama>(\n  format: PersistenceFormat,\n  data: string | Buffer | ArrayBuffer,\n  runtime?: Runtime\n): Promise<T> {\n  if (!runtime) {\n    runtime = detectRuntime()\n  }\n\n  const db = create({\n    schema: {\n      __placeholder: 'string'\n    }\n  })\n  let deserialized: any\n\n  switch (format) {\n    case 'json':\n      deserialized = JSON.parse((data as any).toString())\n      break\n    case 'dpack':\n      deserialized = dpack.parse(data)\n      break\n    case 'binary': {\n      if (runtime === 'node') {\n        data = Buffer.from((data as any).toString(), 'hex')\n        /* c8 ignore next 3 */\n      } else {\n        // @ts-ignore\n        data = slowHexToBuffer(data as string) as Buffer\n      }\n      deserialized = decode(data)\n      break\n    }\n    case 'seqproto':\n      {\n        let ab: ArrayBuffer\n        if (data instanceof ArrayBuffer) {\n          ab = data\n        } else if (ArrayBuffer.isView(data)) {\n          const view = data as unknown as Uint8Array\n          const slice = view.buffer.slice(view.byteOffset, view.byteOffset + view.byteLength)\n          const copy = new Uint8Array(view.byteLength)\n          copy.set(new Uint8Array(slice))\n          ab = copy.buffer\n        } else if (typeof (data as any) === 'string') {\n          // If somehow a base64 or hex string is passed (should not happen in current flow)\n          const buf = Buffer.from(data as string, 'binary')\n          const slice = buf.buffer.slice(buf.byteOffset, buf.byteOffset + buf.byteLength)\n          const copy = new Uint8Array(buf.byteLength)\n          copy.set(new Uint8Array(slice))\n          ab = copy.buffer\n        } else {\n          throw new Error('Unsupported data type for seqproto restore')\n        }\n        deserialized = deserializeOramaInstance(ab)\n      }\n      break\n    default:\n      throw new Error(UNSUPPORTED_FORMAT(format))\n  }\n\n  load(db, deserialized)\n\n  return db as unknown as T\n}\n\nexport async function persistToFile<T extends AnyOrama>(\n  db: T,\n  format: PersistenceFormat = 'json',\n  path?: string,\n  runtime?: Runtime\n): Promise<never> {\n  throw new Error(METHOD_MOVED('persistToFile'))\n}\n\nexport async function restoreFromFile<T extends AnyOrama>(\n  format: PersistenceFormat = 'json',\n  path?: string,\n  runtime?: Runtime\n): Promise<never> {\n  throw new Error(METHOD_MOVED('restoreFromFile'))\n}\n"],"names":["decode","encode","create","load","save","dpack","METHOD_MOVED","UNSUPPORTED_FORMAT","detectRuntime","serializeOramaInstance","deserializeOramaInstance","hexFromMap","a","b","c","d","e","f","hexToMap","Object","keys","slowHexToBuffer","hex","bytes","Uint8Array","Math","floor","length","toLowerCase","i","undefined","slowHexToString","Array","from","map","join","persist","db","format","runtime","dbExport","serialized","JSON","stringify","serialize","msgpack","Buffer","buffer","byteOffset","byteLength","toString","Error","restore","data","schema","__placeholder","deserialized","parse","ab","ArrayBuffer","isView","view","slice","copy","set","buf","persistToFile","path","restoreFromFile"],"mappings":"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"}