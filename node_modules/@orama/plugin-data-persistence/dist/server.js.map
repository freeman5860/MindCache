{"version":3,"sources":["../src/server.ts"],"sourcesContent":["import type { AnyOrama } from '@orama/orama'\nimport { save, create, load } from '@orama/orama'\nimport { encode, decode } from '@msgpack/msgpack'\n// @ts-expect-error dpack does not expose types\nimport * as dpack from 'dpack'\nimport type { FileSystem, PersistenceFormat, Runtime } from './types.js'\nimport { FILESYSTEM_NOT_SUPPORTED_ON_RUNTIME, UNSUPPORTED_FORMAT } from './errors.js'\nimport { persist, restore } from './index.js'\nimport { detectRuntime } from './utils.js'\nimport { serializeOramaInstance } from './seqproto.js'\n\nexport const DEFAULT_DB_NAME = `orama_bump_${+new Date()}`\n\nlet _fs: FileSystem\n\nexport async function persistToFile<T extends AnyOrama>(\n  db: T,\n  format: PersistenceFormat = 'binary',\n  path?: string,\n  runtime?: Runtime\n): Promise<string> {\n  if (!runtime) {\n    runtime = detectRuntime()\n  }\n\n  if (!_fs) {\n    _fs = await loadFileSystem(runtime)\n  }\n\n  if (!path) {\n    path = await getDefaultOutputFilename(format, runtime)\n  }\n\n  // For large datasets, use streaming approach to avoid memory issues\n  await persistToFileStreaming(db, format, path, runtime)\n\n  return path\n}\n\nexport async function restoreFromFile<T extends AnyOrama>(\n  format: PersistenceFormat = 'binary',\n  path?: string,\n  runtime?: Runtime\n): Promise<T> {\n  if (!runtime) {\n    runtime = detectRuntime()\n  }\n\n  if (!_fs) {\n    _fs = await loadFileSystem(runtime)\n  }\n\n  if (!path) {\n    path = await getDefaultOutputFilename(format, runtime)\n  }\n\n  const data = await _fs.readFile(path)\n\n  // Handle new binary format that stores data as binary instead of hex\n  if (format === 'binary' && data instanceof Buffer) {\n    return restoreFromBinaryData(data, runtime)\n  }\n\n  return restore(format, data, runtime)\n}\n\nasync function loadFileSystem(runtime: Runtime): Promise<FileSystem> {\n  switch (runtime) {\n    case 'node': {\n      const { readFile, writeFile } = await import('node:fs/promises')\n      const { resolve } = await import('node:path')\n\n      return {\n        cwd: process.cwd,\n        resolve,\n        readFile: readFile as FileSystem['readFile'],\n        writeFile: writeFile as FileSystem['writeFile']\n      }\n    }\n    /* c8 ignore next 13 */\n    case 'deno': {\n      // @ts-expect-error Deno allows TS imports\n      const { resolve } = await import(/* webpackIgnore: true */ 'https://deno.land/std/path/mod.ts')\n\n      // @ts-expect-error Deno is only available in Deno\n      const { cwd, readTextFile: readFile, writeTextFile: writeFile } = Deno\n\n      return {\n        cwd: cwd as FileSystem['cwd'],\n        resolve: resolve as FileSystem['resolve'],\n        readFile: readFile as FileSystem['readFile'],\n        writeFile: writeFile as FileSystem['writeFile']\n      }\n    }\n    default:\n      throw new Error(FILESYSTEM_NOT_SUPPORTED_ON_RUNTIME(runtime))\n  }\n}\n\nasync function getDefaultOutputFilename(format: PersistenceFormat, runtime: Runtime): Promise<string> {\n  if (!_fs) {\n    _fs = await loadFileSystem(runtime)\n  }\n\n  return _fs.resolve(_fs.cwd(), await getDefaultFileName(format, runtime))\n}\n\nexport async function getDefaultFileName(format: PersistenceFormat, runtime?: Runtime): Promise<string> {\n  if (!runtime) {\n    runtime = detectRuntime()\n  }\n\n  let extension: string\n\n  switch (format) {\n    case 'json':\n      extension = 'json'\n      break\n    case 'dpack':\n      extension = 'dpack'\n      break\n    case 'binary':\n      extension = 'msp'\n      break\n    case 'seqproto':\n      extension = 'seqp'\n      break\n    default:\n      extension = 'dump'\n  }\n\n  let dbName: string = DEFAULT_DB_NAME\n\n  /* c8 ignore next 3 */\n  if (runtime === 'deno') {\n    // @ts-expect-error Deno is only available in Deno\n    dbName = Deno.env.get('ORAMA_DB_NAME') ?? DEFAULT_DB_NAME\n  } else {\n    dbName = process?.env?.ORAMA_DB_NAME ?? DEFAULT_DB_NAME\n  }\n\n  return `${dbName}.${extension}`\n}\n\n// Streaming implementation to handle large datasets without memory issues\nasync function persistToFileStreaming<T extends AnyOrama>(\n  db: T,\n  format: PersistenceFormat,\n  filePath: string,\n  runtime: Runtime\n): Promise<void> {\n  const dbExport = await save(db)\n\n  switch (format) {\n    case 'json':\n      await streamJsonToFile(dbExport, filePath, runtime)\n      break\n    case 'binary':\n      await streamBinaryToFile(dbExport, filePath, runtime)\n      break\n    case 'dpack':\n      // dpack doesn't have streaming support, use regular approach\n      // but check size and warn if too large\n      const dpackSerialized = dpack.serialize(dbExport)\n      await _fs.writeFile(filePath, dpackSerialized)\n      break\n    case 'seqproto':\n      const seqprotoSerialized = serializeOramaInstance(db)\n      const buffer = Buffer.from(seqprotoSerialized)\n      await _fs.writeFile(filePath, buffer)\n      break\n    default:\n      throw new Error(UNSUPPORTED_FORMAT(format))\n  }\n}\n\n// Stream JSON to file using streaming JSON stringification\nasync function streamJsonToFile(data: any, filePath: string, runtime: Runtime): Promise<void> {\n  if (runtime === 'node') {\n    const fs = await import('node:fs')\n    const { createWriteStream } = fs\n\n    return new Promise((resolve, reject) => {\n      const stream = createWriteStream(filePath)\n\n      // For very large objects, we need to stringify in chunks\n      // This is a simplified approach - in production you might want to use\n      // a streaming JSON library\n      try {\n        const jsonString = JSON.stringify(data)\n        stream.write(jsonString)\n        stream.end()\n        stream.on('finish', resolve)\n        stream.on('error', reject)\n      } catch (error) {\n        // If JSON.stringify fails due to size, try chunked approach\n        if (error instanceof Error && error.message.includes('string length')) {\n          streamLargeJsonToFile(data, stream, resolve, reject)\n        } else {\n          reject(error)\n        }\n      }\n    })\n  } else {\n    // For non-Node environments, fall back to regular approach\n    const jsonString = JSON.stringify(data)\n    await _fs.writeFile(filePath, jsonString)\n  }\n}\n\n// Handle extremely large JSON by breaking it into manageable chunks\nfunction streamLargeJsonToFile(data: any, stream: any, resolve: () => void, reject: (error: any) => void): void {\n  try {\n    stream.write('{')\n\n    let isFirst = true\n    for (const [key, value] of Object.entries(data)) {\n      if (!isFirst) {\n        stream.write(',')\n      }\n      isFirst = false\n\n      // Write key\n      stream.write(`\"${key}\":`)\n\n      // For large values, try to stringify them separately\n      try {\n        const valueStr = JSON.stringify(value)\n        stream.write(valueStr)\n      } catch (valueError) {\n        // If individual value is too large, we need different handling\n        console.warn(`Skipping large value for key ${key}:`, valueError)\n        stream.write('null')\n      }\n    }\n\n    stream.write('}')\n    stream.end()\n    stream.on('finish', resolve)\n    stream.on('error', reject)\n  } catch (error) {\n    reject(error)\n  }\n}\n\n// Stream binary data to file without creating large hex strings\nasync function streamBinaryToFile(data: any, filePath: string, runtime: Runtime): Promise<void> {\n  if (runtime === 'node') {\n    const fs = await import('node:fs')\n    const { createWriteStream } = fs\n\n    return new Promise((resolve, reject) => {\n      const stream = createWriteStream(filePath)\n\n      try {\n        // Encode to msgpack first\n        const msgpack = encode(data)\n\n        // Instead of converting to hex string, write binary data directly\n        // This avoids the 2x size increase from hex encoding\n        const buffer = Buffer.from(msgpack.buffer, msgpack.byteOffset, msgpack.byteLength)\n        stream.write(buffer)\n        stream.end()\n        stream.on('finish', resolve)\n        stream.on('error', reject)\n      } catch (error) {\n        reject(error)\n      }\n    })\n  } else {\n    // For non-Node environments, fall back to regular approach\n    const msgpack = encode(data)\n    const buffer = Buffer.from(msgpack.buffer, msgpack.byteOffset, msgpack.byteLength)\n    await _fs.writeFile(filePath, buffer)\n  }\n}\n\n// Helper function to restore from binary data directly\nasync function restoreFromBinaryData<T extends AnyOrama>(data: Buffer, runtime: Runtime): Promise<T> {\n  const db = create({\n    schema: {\n      __placeholder: 'string'\n    }\n  })\n\n  const deserialized = decode(data) as any\n  load(db, deserialized)\n\n  return db as unknown as T\n}\n"],"names":["save","create","load","encode","decode","dpack","FILESYSTEM_NOT_SUPPORTED_ON_RUNTIME","UNSUPPORTED_FORMAT","restore","detectRuntime","serializeOramaInstance","DEFAULT_DB_NAME","Date","_fs","persistToFile","db","format","path","runtime","loadFileSystem","getDefaultOutputFilename","persistToFileStreaming","restoreFromFile","data","readFile","Buffer","restoreFromBinaryData","writeFile","resolve","cwd","process","readTextFile","writeTextFile","Deno","Error","getDefaultFileName","extension","dbName","env","get","ORAMA_DB_NAME","filePath","dbExport","streamJsonToFile","streamBinaryToFile","dpackSerialized","serialize","seqprotoSerialized","buffer","from","fs","createWriteStream","Promise","reject","stream","jsonString","JSON","stringify","write","end","on","error","message","includes","streamLargeJsonToFile","isFirst","key","value","Object","entries","valueStr","valueError","console","warn","msgpack","byteOffset","byteLength","schema","__placeholder","deserialized"],"mappings":"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"}